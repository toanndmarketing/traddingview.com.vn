version: '3.8'

services:
  mysql:
    image: mysql:8.0
    container_name: ghost-mysql
    restart: unless-stopped
    mem_limit: 4500m
    mem_reservation: 3000m
    mem_swappiness: 0
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE}
      MYSQL_USER: ${MYSQL_USER}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
    volumes:
      - mysql_data:/var/lib/mysql

    command:
      - --default-authentication-plugin=mysql_native_password
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
      - --innodb-buffer-pool-size=3G
      - --innodb-log-file-size=512M
      - --innodb-redo-log-capacity=2G
      - --innodb-flush-log-at-trx-commit=2
      - --max-connections=300
      - --table-open-cache=8000
      - --wait-timeout=86400
      - --interactive-timeout=86400
      - --max-allowed-packet=1073741824
      - --performance_schema=OFF
      - --skip-log-bin
    healthcheck:
      test: [ "CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${MYSQL_ROOT_PASSWORD}" ]
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    container_name: ghost-redis
    restart: unless-stopped
    mem_limit: 512m
    mem_reservation: 256m
    command: redis-server --maxmemory 400mb --maxmemory-policy allkeys-lru
    volumes:
      - redis_data:/data

  nginx:
    image: nginx:alpine
    container_name: ghost-nginx
    restart: unless-stopped
    ports:
      - "127.0.0.1:3005:80"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - nginx_cache:/var/cache/nginx
    depends_on:
      - ghost

  # Cache Purge Server - nhận webhook từ Ghost để clear nginx cache
  cache-purge:
    image: node:18-alpine
    container_name: ghost-cache-purge
    restart: unless-stopped
    working_dir: /app
    #    ports:
    #      - "9000:9000"
    environment:
      - WEBHOOK_SECRET=${WEBHOOK_SECRET}
    volumes:
      - ./scripts/cache-purge-server.js:/app/server.js:ro
      - nginx_cache:/var/cache/nginx
    command: node server.js
    depends_on:
      - nginx

  # Mail Server cho nội bộ (Mailpit)
  mailpit:
    image: axllent/mailpit
    container_name: ghost-mailpit
    restart: unless-stopped
    ports:
      - "127.0.0.1:8025:8025"
      - "127.0.0.1:1025:1025"

  ghost:
    build: .
    container_name: ghost-tradingview
    restart: unless-stopped
    mem_limit: 1024m
    mem_reservation: 512m
    depends_on:
      mysql:
        condition: service_healthy
    environment:
      NODE_ENV: ${GHOST_NODE_ENV}
      NODE_OPTIONS: --max-old-space-size=768
      database__client: mysql
      database__connection__host: mysql
      database__connection__user: ${MYSQL_USER}
      database__connection__password: ${MYSQL_PASSWORD}
      database__connection__database: ${MYSQL_DATABASE}
      adapters__cache__Redis__host: ${REDIS_HOST}
      adapters__cache__Redis__port: ${REDIS_PORT}
      adapters__cache__Redis__ttl: ${REDIS_TTL}

      # Mail Configuration
      mail__transport: ${MAIL_TRANSPORT}
      mail__options__host: ${MAIL_HOST}
      mail__options__port: ${MAIL_PORT}
      mail__options__secureConnection: "false"
      mail__options__auth__user: ${MAIL_USER}
      mail__options__auth__pass: ${MAIL_PASS}
      mail__from: ${MAIL_FROM}

      # Setup S3 via ENV to keep config clean
      storage__active: s3
      storage__s3__accessKeyId: ${S3_ACCESS_KEY_ID}
      storage__s3__secretAccessKey: ${S3_SECRET_ACCESS_KEY}
      storage__s3__region: ${S3_REGION}
      storage__s3__bucket: ${S3_BUCKET}
      storage__s3__assetHost: ${S3_ASSET_HOST}
      storage__s3__forcePathStyle: "true"
      storage__s3__acl: private
    volumes:
      - ./content:/var/lib/ghost/content
      # - ./config.docker.json:/var/lib/ghost/config.production.json # Bỏ file này đi, dùng ENV hoàn toàn cho production
    healthcheck:
      test: [ "CMD", "nc", "-z", "127.0.0.1", "3000" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

volumes:
  mysql_data:
  redis_data:
  nginx_cache:
