events {
    worker_connections 1024;
}

http {
    # ============================================
    # RATE LIMITING - Chống click ảo/DDoS
    # ============================================
    
    # Zone cho rate limit theo IP (10MB zone ~ 160,000 IPs)
    # 10r/s = 10 requests/giây, burst=20 cho phép đột biến ngắn
    limit_req_zone $binary_remote_addr zone=req_limit_per_ip:10m rate=10r/s;
    
    # Zone cho rate limit theo IP cho /ghost (admin) - nghiêm ngặt hơn
    limit_req_zone $binary_remote_addr zone=admin_limit:5m rate=5r/s;
    
    # Zone cho connection limit
    limit_conn_zone $binary_remote_addr zone=conn_limit_per_ip:10m;
    
    # Trả về 429 (Too Many Requests) thay vì 503
    limit_req_status 429;
    limit_conn_status 429;

    # ============================================
    # GEO BLOCKING - Chặn các IP đáng ngờ (tuỳ chọn)
    # ============================================
    # geo $blocked_ip {
    #     default 0;
    #     # Thêm IP/range cần chặn
    #     # 1.2.3.4 1;
    #     # 5.6.7.0/24 1;
    # }

    # ============================================
    # BOT USER-AGENT MAPPING
    # ============================================
    map $http_user_agent $bad_bot {
        default 0;
        
        # Empty User-Agent
        "" 1;
        "-" 1;
        
        # Các tool scraping/attack phổ biến
        ~*(?:wget|curl|libwww|python|perl|ruby|java|httpclient) 1;
        ~*(?:scrapy|phantomjs|headless|selenium|puppeteer|playwright) 1;
        ~*(?:bot|crawl|spider|slurp|archive) 1;
        
        # Các bad bot cụ thể
        ~*(?:ahrefsbot|semrushbot|dotbot|mj12bot|blexbot) 1;
        ~*(?:dataforseobot|serpstatbot|megaindex|zoominfobot) 1;
        ~*(?:petalbot|bytespider|yandexbot|baiduspider) 1;
        ~*(?:sogou|exabot|majestic|linkdexbot) 1;
        
        # Click fraud / Ad fraud bots
        ~*(?:clickbot|fraudbot|trafficbot|hitbot) 1;
        ~*(?:fake|fraud|spam|attack|scan|hack) 1;
        
        # Các tool tấn công
        ~*(?:nikto|sqlmap|nmap|masscan|zmap) 1;
        ~*(?:dirbuster|gobuster|wfuzz|hydra|burp) 1;
        
        # Các User-Agent giả mạo/đáng ngờ
        ~*(?:zgrab|httpx|nuclei|shodan|censys) 1;
    }

    # Whitelist các bot tốt (Google, Bing, Facebook, etc.)
    map $http_user_agent $good_bot {
        default 0;
        ~*(?:googlebot|google-inspectiontool|adsbot-google) 1;
        ~*(?:bingbot|msnbot|adidxbot) 1;
        ~*(?:facebookexternalhit|facebot|facebookcatalog) 1;
        ~*(?:twitterbot|linkedinbot|pinterest|slackbot) 1;
        ~*(?:telegrambot|whatsapp|discordbot) 1;
        ~*(?:applebot|duckduckbot) 1;
    }

    # Logic: Block nếu là bad_bot VÀ không phải good_bot
    map $bad_bot$good_bot $block_bot {
        "00" 0;  # Không phải bad bot, không phải good bot -> OK
        "01" 0;  # Không phải bad bot, là good bot -> OK
        "10" 1;  # Là bad bot, không phải good bot -> BLOCK
        "11" 0;  # Là bad bot nhưng cũng match good bot -> OK (ưu tiên good)
    }

    # ============================================
    # SUSPICIOUS REQUEST PATTERNS
    # ============================================
    map $request_uri $suspicious_uri {
        default 0;
        # Các path tấn công phổ biến
        ~*(?:\.php|\.asp|\.aspx|\.jsp|\.cgi) 1;
        ~*(?:wp-admin|wp-login|wp-content|wordpress) 1;
        ~*(?:phpmyadmin|adminer|mysql|database) 1;
        ~*(?:\.env|\.git|\.svn|\.htaccess|\.htpasswd) 1;
        ~*(?:shell|eval|exec|system|passthru) 1;
        ~*(?:etc/passwd|proc/self|boot\.ini) 1;
    }

    # ============================================
    # CLOUDFLARE REAL IP (Quan trọng!)
    # ============================================
    # Cloudflare IPv4
    set_real_ip_from 173.245.48.0/20;
    set_real_ip_from 103.21.244.0/22;
    set_real_ip_from 103.22.200.0/22;
    set_real_ip_from 103.31.4.0/22;
    set_real_ip_from 141.101.64.0/18;
    set_real_ip_from 108.162.192.0/18;
    set_real_ip_from 190.93.240.0/20;
    set_real_ip_from 188.114.96.0/20;
    set_real_ip_from 197.234.240.0/22;
    set_real_ip_from 198.41.128.0/17;
    set_real_ip_from 162.158.0.0/15;
    set_real_ip_from 104.16.0.0/13;
    set_real_ip_from 104.24.0.0/14;
    set_real_ip_from 172.64.0.0/13;
    set_real_ip_from 131.0.72.0/22;
    
    # Cloudflare IPv6
    set_real_ip_from 2400:cb00::/32;
    set_real_ip_from 2606:4700::/32;
    set_real_ip_from 2803:f800::/32;
    set_real_ip_from 2405:b500::/32;
    set_real_ip_from 2405:8100::/32;
    set_real_ip_from 2a06:98c0::/29;
    set_real_ip_from 2c0f:f248::/32;
    
    real_ip_header CF-Connecting-IP;
    # Hoặc dùng: real_ip_header X-Forwarded-For;

    # ============================================
    # LOGGING FORMAT - Để phân tích click ảo
    # ============================================
    log_format detailed '$remote_addr - $remote_user [$time_local] '
                        '"$request" $status $body_bytes_sent '
                        '"$http_referer" "$http_user_agent" '
                        'rt=$request_time uct="$upstream_connect_time" '
                        'uht="$upstream_header_time" urt="$upstream_response_time" '
                        'cf_ip="$http_cf_connecting_ip" cf_country="$http_cf_ipcountry"';

    upstream ghost {
        server ghost:3000;
        keepalive 32;
    }

    server {
        listen 80;
        server_name _;

        # Access log với format chi tiết
        access_log /var/log/nginx/access.log detailed;
        error_log /var/log/nginx/error.log warn;

        # ============================================
        # SECURITY HEADERS
        # ============================================
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-XSS-Protection "1; mode=block" always;
        add_header Referrer-Policy "strict-origin-when-cross-origin" always;

        # ============================================
        # BLOCK BAD BOTS & SUSPICIOUS REQUESTS
        # ============================================
        
        # Chặn bad bots
        if ($block_bot = 1) {
            return 403;
        }
        
        # Chặn suspicious URIs
        if ($suspicious_uri = 1) {
            return 404;
        }

        # Chặn requests không có User-Agent (tuỳ chọn - có thể gây false positive)
        # if ($http_user_agent = "") {
        #     return 403;
        # }

        # Chặn IP trong blacklist (nếu dùng geo block)
        # if ($blocked_ip) {
        #     return 403;
        # }

        # ============================================
        # RATE LIMITING CHO ADMIN PANEL
        # ============================================
        location /ghost {
            # Giới hạn 5 req/s, burst 10, không delay
            limit_req zone=admin_limit burst=10 nodelay;
            limit_conn conn_limit_per_ip 10;
            
            proxy_pass http://ghost;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto https;
            proxy_set_header X-Forwarded-Host $host;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            proxy_buffering off;
        }

        # ============================================
        # RATE LIMITING CHO API (nếu có)
        # ============================================
        location /ghost/api {
            limit_req zone=admin_limit burst=5 nodelay;
            limit_conn conn_limit_per_ip 5;
            
            proxy_pass http://ghost;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto https;
            proxy_set_header X-Forwarded-Host $host;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            proxy_buffering off;
        }

        # ============================================
        # STATIC FILES - Ít rate limit hơn
        # ============================================
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot|webp|avif)$ {
            limit_req zone=req_limit_per_ip burst=50 nodelay;
            
            proxy_pass http://ghost;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto https;
            proxy_set_header X-Forwarded-Host $host;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            
            # Cache static files
            proxy_cache_valid 200 1d;
            expires 7d;
            add_header Cache-Control "public, immutable";
        }

        # ============================================
        # MAIN LOCATION - Rate limited
        # ============================================
        location / {
            # Giới hạn 10 req/s per IP, cho phép burst 20
            limit_req zone=req_limit_per_ip burst=20 nodelay;
            
            # Giới hạn 20 connections đồng thời per IP
            limit_conn conn_limit_per_ip 20;
            
            proxy_pass http://ghost;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto https;
            proxy_set_header X-Forwarded-Host $host;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            proxy_buffering off;
            
            # Timeout settings
            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
        }

        # ============================================
        # BLOCK COMMON ATTACK PATHS
        # ============================================
        location ~ /\. {
            deny all;
            return 404;
        }
        
        location ~* (?:\.(?:bak|conf|dist|fla|in[ci]|log|orig|psd|sh|sql|sw[op])|~)$ {
            deny all;
            return 404;
        }
    }
}

